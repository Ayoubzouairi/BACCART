<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>تحليل آخر 5 جولات + الإصابات — BACCARAT SPEED</title>
<style>
  :root{--bg:#0f1115;--card:#121418;--accent:gold;--muted:#9aa0a6;--glass:rgba(255,255,255,0.03)}
  body{margin:0;font-family:Inter, "Segoe UI", Tahoma, sans-serif;background:linear-gradient(180deg,#071018 0%, #0b1220 100%);color:#e9eef2}
  .wrap{max-width:920px;margin:28px auto;padding:20px}
  h1{color:var(--accent);margin:0 0 12px;font-size:20px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  .card{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,0.6)}
  label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
  input[type=text], textarea, select{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:var(--glass);color:inherit}
  button{background:var(--accent);border:none;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600}
  .result{margin-top:12px}
  .small{font-size:13px;color:var(--muted)}
  .player-card{background:rgba(255,255,255,0.02);padding:8px;border-radius:8px;margin:8px 0}
  .bar{height:12px;background:rgba(255,255,255,0.06);border-radius:8px;overflow:hidden}
  .bar > i{display:block;height:100%;background:linear-gradient(90deg,#ffd966,#ffb84d);width:0%}
  pre{white-space:pre-wrap;color:#cfe8ff;font-size:13px}
  @media(max-width:800px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
  <div class="wrap">
    <h1>تحليل آخر 5 جولات + الإصابات → Over/Under & Double Chance</h1>

    <div class="grid">
      <div class="card">
        <label>اسم الفريق الأول (Team A)</label>
        <input id="teamA" type="text" placeholder="مثال: Barcelona" value="Barcelona">

        <label style="margin-top:8px">آخر 5 جولات — عدد الأهداف لكل ماتش (Team A) — coma-separated</label>
        <input id="lastA" type="text" placeholder="مثال: 2,1,3,0,1" value="2,1,3,0,1">

        <label style="margin-top:8px">اسم الفريق الثاني (Team B)</label>
        <input id="teamB" type="text" placeholder="مثال: Real Madrid" value="Real Madrid">

        <label style="margin-top:8px">آخر 5 جولات — عدد الأهداف لكل ماتش (Team B)</label>
        <input id="lastB" type="text" placeholder="مثال: 1,2,0,1,3" value="1,2,0,1,3">

        <div style="margin-top:10px;display:flex;gap:8px">
          <button onclick="analyze()">حسب دابا</button>
          <button onclick="fetchInjuriesBoth()">جيب الإصابات من API (TheSportsDB)</button>
        </div>

        <div class="small" style="margin-top:8px">
          ملاحظة: نموذج الاحتمالات مبني على Poisson مستقل لكل فريق وتعديل بسيط حسب عدد المصابين.
        </div>
      </div>

      <div class="card">
        <label>إعدادات سريعة</label>
        <div style="display:flex;gap:8px">
          <div style="flex:1">
            <label>حد الأداء للاحتمالات (max goals calc)</label>
            <select id="maxGoals">
              <option value="6">0–6 (سريع)</option>
              <option value="8">0–8 (أدق شوية)</option>
            </select>
          </div>
          <div style="width:120px">
            <label>تأثير كل إصابة (%)</label>
            <input id="injPercent" type="text" value="8">
          </div>
        </div>

        <div style="margin-top:12px">
          <label>الإصابات الممسوكة يدويًا (اختياري)</label>
          <textarea id="manualInj" rows="4" placeholder="مثال: A:Pedri, Gavi&#10;B:Kroos"></textarea>
          <div class="small" style="margin-top:6px">صيغة: اكتب A:اسم1,اسم2 ثم سطر جديد B:... أو استعمل زر 'جيب الإصابات' للحصول على بيانات من TheSportsDB.</div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:14px">
      <h3 style="margin:0 0 8px">النتائج</h3>
      <div id="output" class="result">
        <div class="small">ضغط "حسب دابا" باش تبدا التحليلات.</div>
      </div>
    </div>

  </div>

<script>
/* --- Utilities --- */
function parseGoals(str){
  if(!str) return [];
  return str.split(',').map(s=>{ const n = parseInt(s.trim()); return isNaN(n)?0:n; }).slice(0,5);
}
function avg(arr){
  if(!arr.length) return 0;
  return arr.reduce((a,b)=>a+b,0)/arr.length;
}
function poissonProb(k, lambda){
  // e^-λ λ^k / k!
  return Math.exp(-lambda) * Math.pow(lambda, k) / factorial(k);
}
function factorial(n){
  let f=1;
  for(let i=2;i<=n;i++) f*=i;
  return f;
}

/* --- Fetch injuries from TheSportsDB (searchplayers returns player.strInjury) --- */
async function fetchInjuriesForTeam(teamName){
  try{
    const url = `https://www.thesportsdb.com/api/v1/json/3/searchplayers.php?t=${encodeURIComponent(teamName)}`;
    const res = await fetch(url);
    const data = await res.json();
    if(!data || !data.player) return [];
    const injured = data.player.filter(p => p.strInjury && p.strInjury.trim() !== "");
    return injured.map(p => ({name: p.strPlayer, team: p.strTeam, pos: p.strPosition, injury: p.strInjury}));
  }catch(e){
    console.warn('fetch error', e);
    return [];
  }
}

async function fetchInjuriesBoth(){
  const a = document.getElementById('teamA').value.trim();
  const b = document.getElementById('teamB').value.trim();
  const out = document.getElementById('output');
  out.innerHTML = '⏳ كنجلب الإصابات...';
  const [injA, injB] = await Promise.all([fetchInjuriesForTeam(a), fetchInjuriesForTeam(b)]);
  // put manual injuries into textarea
  let manual = document.getElementById('manualInj').value || "";
  if(injA.length) manual += (manual?'\n':'') + `A:${injA.map(x=>x.name).join(',')}`;
  if(injB.length) manual += (manual?'\n':'') + `B:${injB.map(x=>x.name).join(',')}`;
  document.getElementById('manualInj').value = manual;
  renderInjuriesSummary(injA, injB);
}

function renderInjuriesSummary(injA, injB){
  const out = document.getElementById('output');
  out.innerHTML = `
    <div><strong>Injuries fetched:</strong></div>
    <div style="display:flex;gap:12px;margin-top:8px">
      <div style="flex:1">
        <div class="small">Team A (${document.getElementById('teamA').value.trim()}): ${injA.length} مصاب</div>
        ${injA.map(p=>`<div class="player-card"><strong>${p.name}</strong><div class="small">${p.pos} — ${p.injury}</div></div>`).join('')}
      </div>
      <div style="flex:1">
        <div class="small">Team B (${document.getElementById('teamB').value.trim()}): ${injB.length} مصاب</div>
        ${injB.map(p=>`<div class="player-card"><strong>${p.name}</strong><div class="small">${p.pos} — ${p.injury}</div></div>`).join('')}
      </div>
    </div>
  `;
}

/* --- Main analysis --- */
function analyze(){
  const teamA = document.getElementById('teamA').value.trim() || 'Team A';
  const teamB = document.getElementById('teamB').value.trim() || 'Team B';
  const lastA = parseGoals(document.getElementById('lastA').value);
  const lastB = parseGoals(document.getElementById('lastB').value);
  const maxG = parseInt(document.getElementById('maxGoals').value || '6');
  const injPercent = parseFloat(document.getElementById('injPercent').value) || 8;

  // manual injuries textarea parsing
  const manual = (document.getElementById('manualInj').value || '').split('\n');
  let injA_manual = [], injB_manual = [];
  manual.forEach(line=>{
    const L = line.trim();
    if(!L) return;
    if(L.startsWith('A:') || L.startsWith('a:')) injA_manual = L.slice(2).split(',').map(s=>s.trim()).filter(Boolean);
    if(L.startsWith('B:') || L.startsWith('b:')) injB_manual = L.slice(2).split(',').map(s=>s.trim()).filter(Boolean);
  });

  // basic stats
  const avgA = avg(lastA);
  const avgB = avg(lastB);

  // injury counts
  const injCountA = injA_manual.length;
  const injCountB = injB_manual.length;

  // injury factor: each injured player reduces lambda by injPercent% but clamp so factor>=0.6
  const minFactor = 0.6;
  const factorA = Math.max(minFactor, 1 - (injPercent/100) * injCountA);
  const factorB = Math.max(minFactor, 1 - (injPercent/100) * injCountB);

  // adjusted lambdas
  const lambdaA = avgA * factorA;
  const lambdaB = avgB * factorB;

  // compute distribution up to maxG for each team
  const probsA = [], probsB = [];
  for(let i=0;i<=maxG;i++){
    probsA[i] = poissonProb(i, lambdaA);
    probsB[i] = poissonProb(i, lambdaB);
  }
  // probability mass beyond maxG (tail)
  const tailA = 1 - probsA.reduce((s,x)=>s+x,0);
  const tailB = 1 - probsB.reduce((s,x)=>s+x,0);

  // outcome matrix (independent Poisson)
  let pHome=0, pDraw=0, pAway=0;
  const matrix = [];
  for(let i=0;i<=maxG;i++){
    matrix[i]=[];
    for(let j=0;j<=maxG;j++){
      const pa = probsA[i] !== undefined ? probsA[i] : 0;
      const pb = probsB[j] !== undefined ? probsB[j] : 0;
      const p = pa * pb;
      matrix[i][j]=p;
      if(i>j) pHome += p;
      else if(i===j) pDraw += p;
      else pAway += p;
    }
  }
  // add tails approx by distributing tail mass equally across last row/col (simple approx)
  // this is a crude correction: distribute tails to "maxG+1" bucket (ignored detailed)
  // For better accuracy, increase maxG.
  // total prob from matrix:
  const matrixTotal = matrix.flat().reduce((s,x)=>s+x,0);
  const remainder = (1 - matrixTotal);
  // allocate remainder proportional to existing outcomes
  if(remainder > 1e-9){
    // rough allocation using current proportions
    const total = pHome + pDraw + pAway;
    if(total>0){
      pHome += remainder * (pHome/total);
      pDraw += remainder * (pDraw/total);
      pAway += remainder * (pAway/total);
    }
  }

  // total goals distribution approximate lambdaTotal
  const lambdaTotal = lambdaA + lambdaB;
  // P(total <= 2) = sum_{k=0..2} e^-λ λ^k / k!
  let pTotLE2 = 0;
  for(let k=0;k<=2;k++) pTotLE2 += poissonProb(k, lambdaTotal);
  const pOver25 = 1 - pTotLE2;
  const pUnder25 = pTotLE2;

  // Double chance
  const doubleHome_Draw = pHome + pDraw;
  const doubleHome_Away = pHome + pAway;
  const doubleDraw_Away = pDraw + pAway;

  // prepare output
  const out = document.getElementById('output');
  out.innerHTML = `
    <div style="display:flex;gap:12px;flex-wrap:wrap">
      <div style="flex:1;min-width:260px">
        <strong>${teamA}</strong>
        <div class="small">avg goals (last5): ${avgA.toFixed(2)} → adjusted λ: ${lambdaA.toFixed(2)} (inj:${injCountA})</div>
      </div>
      <div style="flex:1;min-width:260px">
        <strong>${teamB}</strong>
        <div class="small">avg goals (last5): ${avgB.toFixed(2)} → adjusted λ: ${lambdaB.toFixed(2)} (inj:${injCountB})</div>
      </div>
    </div>

    <div style="margin-top:10px">
      <div class="small">احتمالات نتيجة المباراة (تقريبية، Poisson مستقل):</div>
      <div style="display:flex;gap:8px;margin-top:6px;flex-wrap:wrap">
        <div style="flex:1;min-width:140px" class="card">
          <div><strong>Home Win</strong></div>
          <div class="small">${(pHome*100).toFixed(1)}%</div>
          <div class="bar" style="margin-top:6px"><i style="width:${(pHome*100).toFixed(1)}%"></i></div>
        </div>
        <div style="flex:1;min-width:140px" class="card">
          <div><strong>Draw</strong></div>
          <div class="small">${(pDraw*100).toFixed(1)}%</div>
          <div class="bar" style="margin-top:6px"><i style="width:${(pDraw*100).toFixed(1)}%"></i></div>
        </div>
        <div style="flex:1;min-width:140px" class="card">
          <div><strong>Away Win</strong></div>
          <div class="small">${(pAway*100).toFixed(1)}%</div>
          <div class="bar" style="margin-top:6px"><i style="width:${(pAway*100).toFixed(1)}%"></i></div>
        </div>
      </div>
    </div>

    <div style="margin-top:12px">
      <div class="small">Double Chance (نسبة مئوية):</div>
      <div style="display:flex;gap:8px;margin-top:6px;flex-wrap:wrap">
        <div class="card" style="min-width:200px">
          <div><strong>Home or Draw</strong> — ${(doubleHome_Draw*100).toFixed(1)}%</div>
        </div>
        <div class="card" style="min-width:200px">
          <div><strong>Home or Away</strong> — ${(doubleHome_Away*100).toFixed(1)}%</div>
        </div>
        <div class="card" style="min-width:200px">
          <div><strong>Draw or Away</strong> — ${(doubleDraw_Away*100).toFixed(1)}%</div>
        </div>
      </div>
    </div>

    <div style="margin-top:12px">
      <div class="small">Over/Under 2.5:</div>
      <div style="display:flex;gap:8px;margin-top:6px;">
        <div class="card" style="flex:1">
          <div><strong>Over 2.5</strong> — ${(pOver25*100).toFixed(1)}%</div>
          <div class="small">(λ total = ${lambdaTotal.toFixed(2)})</div>
        </div>
        <div class="card" style="flex:1">
          <div><strong>Under 2.5</strong> — ${(pUnder25*100).toFixed(1)}%</div>
        </div>
      </div>
    </div>

    <div style="margin-top:12px">
      <div class="small">ملاحظات تأثير الإصابات:</div>
      <div class="small">كل مصاب ينقص λ الفريق بنسبة ${injPercent}% حتى حد أدنى ${Math.round(minFactor*100)}% من λ الأصلية.</div>
    </div>

    <div style="margin-top:12px" class="card">
      <strong>تفاصيل تقنية (مصفوفة احتمالات مختصرة 0..${maxG})</strong>
      <pre>${generateMatrixText(matrix, maxG)}</pre>
    </div>

  `;
}

/* pretty-print matrix summary */
function generateMatrixText(matrix, maxG){
  // header
  let s = '    ';
  for(let j=0;j<=maxG;j++) s += (j+' ').padStart(6,' ');
  s += '\n';
  for(let i=0;i<=maxG;i++){
    s += (i+' |').padStart(4,' ');
    for(let j=0;j<=maxG;j++){
      const v = matrix[i][j] || 0;
      s += (' '+(v*100).toFixed(2)+'%').padStart(6,' ');
    }
    s += '\n';
  }
  return s;
}
</script>
</body>
</html>
