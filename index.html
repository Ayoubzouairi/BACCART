<!DOCTYPE html>
<html lang="ar">
<head>
  <!-- ... (بقية head كما هو) ... -->
  <style>
    /* أنماط جديدة محسنة */
    .trends-container {
      margin-top: 15px;
      padding: 15px;
      background: linear-gradient(135deg, rgba(0,0,0,0.3), rgba(0,0,0,0.2));
      border-radius: 12px;
      border-left: 4px solid gold;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    
    .trends-container h3 {
      margin-top: 0;
      color: gold;
      text-align: center;
    }
    
    .trend-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      margin: 5px 0;
      border-radius: 8px;
      background-color: rgba(255,255,255,0.05);
    }
    
    .trend-indicator {
      font-size: 1.3em;
      margin-left: 8px;
    }
    
    .trend-value {
      font-weight: bold;
    }
    
    .hot-streak {
      background: linear-gradient(90deg, rgba(255,87,34,0.1), rgba(255,87,34,0.3));
      animation: pulse-hot 1.5s infinite;
    }
    
    .cold-streak {
      background: linear-gradient(90deg, rgba(33,150,243,0.1), rgba(33,150,243,0.3));
      animation: pulse-cold 1.5s infinite;
    }
    
    @keyframes pulse-hot {
      0% { box-shadow: 0 0 0 0 rgba(255,87,34,0.4); }
      70% { box-shadow: 0 0 0 8px rgba(255,87,34,0); }
      100% { box-shadow: 0 0 0 0 rgba(255,87,34,0); }
    }
    
    @keyframes pulse-cold {
      0% { box-shadow: 0 0 0 0 rgba(33,150,243,0.4); }
      70% { box-shadow: 0 0 0 8px rgba(33,150,243,0); }
      100% { box-shadow: 0 0 0 0 rgba(33,150,243,0); }
    }
    
    .patterns-container {
      margin-top: 15px;
      padding: 10px;
      background-color: rgba(255,215,0,0.05);
      border-radius: 8px;
    }
    
    .pattern-badge {
      display: inline-block;
      padding: 5px 10px;
      margin: 3px;
      background-color: rgba(255,215,0,0.2);
      border-radius: 15px;
      font-size: 0.85em;
      cursor: help;
      position: relative;
      transition: all 0.2s;
    }
    
    .pattern-badge:hover {
      background-color: rgba(255,215,0,0.3);
      transform: translateY(-2px);
    }
    
    .pattern-tooltip {
      visibility: hidden;
      width: 200px;
      background-color: rgba(0,0,0,0.8);
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 5px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    .pattern-badge:hover .pattern-tooltip {
      visibility: visible;
      opacity: 1;
    }
  </style>
</head>
<body>
  <!-- ... (بقية الهيكل كما هو) ... -->
  
  <div class="ai-stats" id="aiStats"></div>
  
  <!-- قسم المؤشرات المحسن -->
  <div class="trends-container" id="trendsContainer">
    <h3>📈 تحليل الاتجاهات والأنماط</h3>
    <div id="trendsContent"></div>
  </div>
  
  <div class="ai-advice" id="aiAdvice"></div>
  
  <!-- ... (بقية الهيكل كما هو) ... -->

  <script>
    // ... (بقية الدوال كما هي) ...

    // دالة محسنة لتحليل الاتجاهات
    function updateTrendsAndStreaks() {
      const lang = document.getElementById('langSelect').value;
      const isArabic = lang === 'ar-MA';
      
      if (history.length < 3) {
        document.getElementById('trendsContent').innerHTML = isArabic ? 
          `<div style="text-align:center;padding:10px;">⏳ انتظر المزيد من الجولات لتحليل الاتجاهات...</div>` : 
          `<div style="text-align:center;padding:10px;">⏳ Wait for more rounds to analyze trends...</div>`;
        return;
      }

      const lastSeven = history.slice(-7);
      const lastFourteen = history.length >= 14 ? history.slice(-14, -7) : [];
      
      const counts = { P: 0, B: 0, T: 0 };
      const prevCounts = { P: 0, B: 0, T: 0 };
      
      lastSeven.forEach(r => counts[r]++);
      lastFourteen.forEach(r => prevCounts[r]++);
      
      // حساب التغيرات النسبية
      const getTrend = (current, prev, total) => {
        const change = total > 0 ? ((current - prev) / total * 100) : 0;
        if (change > 15) return { icon: '▲▲', class: 'trend-up', text: isArabic ? 'ارتفاع كبير' : 'Sharp rise' };
        if (change > 5) return { icon: '▲', class: 'trend-up', text: isArabic ? 'ارتفاع' : 'Rising' };
        if (change < -15) return { icon: '▼▼', class: 'trend-down', text: isArabic ? 'انخفاض كبير' : 'Sharp drop' };
        if (change < -5) return { icon: '▼', class: 'trend-down', text: isArabic ? 'انخفاض' : 'Dropping' };
        return { icon: '➔', class: 'trend-neutral', text: isArabic ? 'مستقر' : 'Stable' };
      };
      
      const pTrend = getTrend(counts.P, prevCounts.P, lastSeven.length);
      const bTrend = getTrend(counts.B, prevCounts.B, lastSeven.length);
      const tTrend = getTrend(counts.T, prevCounts.T, lastSeven.length);
      
      // تحليل السلاسل
      const hotThreshold = 0.7; // 70% أو أكثر
      const coldThreshold = 0.2; // 20% أو أقل
      
      const isHot = (type) => counts[type] / lastSeven.length >= hotThreshold;
      const isCold = (type) => counts[type] / lastSeven.length <= coldThreshold;
      
      // تحليل الأنماط المتقدمة
      const patterns = detectAdvancedPatterns(history.slice(-15));
      
      // إنشاء واجهة المستخدم
      const trendsHTML = `
        <div style="margin-bottom: 15px;">
          <h4 style="margin-bottom: 10px;color:gold;">${isArabic ? 'اتجاهات آخر 7 جولات' : 'Last 7 Rounds Trends'}</h4>
          
          <div class="trend-item ${isHot('P') ? 'hot-streak' : ''} ${isCold('P') ? 'cold-streak' : ''}">
            <div>
              <span class="player-text">${isArabic ? 'لاعب' : 'Player'}</span>
              <span class="trend-value">${counts.P}/${lastSeven.length} (${Math.round(counts.P/lastSeven.length*100)}%)</span>
            </div>
            <div>
              <span class="trend-indicator ${pTrend.class}" title="${pTrend.text}">${pTrend.icon}</span>
              ${isHot('P') ? '<span class="streak-indicator hot-streak">HOT</span>' : ''}
              ${isCold('P') ? '<span class="streak-indicator cold-streak">COLD</span>' : ''}
            </div>
          </div>
          
          <div class="trend-item ${isHot('B') ? 'hot-streak' : ''} ${isCold('B') ? 'cold-streak' : ''}">
            <div>
              <span class="banker-text">${isArabic ? 'مصرفي' : 'Banker'}</span>
              <span class="trend-value">${counts.B}/${lastSeven.length} (${Math.round(counts.B/lastSeven.length*100)}%)</span>
            </div>
            <div>
              <span class="trend-indicator ${bTrend.class}" title="${bTrend.text}">${bTrend.icon}</span>
              ${isHot('B') ? '<span class="streak-indicator hot-streak">HOT</span>' : ''}
              ${isCold('B') ? '<span class="streak-indicator cold-streak">COLD</span>' : ''}
            </div>
          </div>
          
          <div class="trend-item ${isHot('T') ? 'hot-streak' : ''} ${isCold('T') ? 'cold-streak' : ''}">
            <div>
              <span class="tie-text">${isArabic ? 'تعادل' : 'Tie'}</span>
              <span class="trend-value">${counts.T}/${lastSeven.length} (${Math.round(counts.T/lastSeven.length*100)}%)</span>
            </div>
            <div>
              <span class="trend-indicator ${tTrend.class}" title="${tTrend.text}">${tTrend.icon}</span>
              ${isHot('T') ? '<span class="streak-indicator hot-streak">HOT</span>' : ''}
              ${isCold('T') ? '<span class="streak-indicator cold-streak">COLD</span>' : ''}
            </div>
          </div>
        </div>
        
        ${patterns.length > 0 ? `
        <div class="patterns-container">
          <h4 style="margin-top:0;margin-bottom:10px;color:gold;">${isArabic ? 'الأنماط المكتشفة' : 'Detected Patterns'}</h4>
          ${patterns.map(p => `
            <div class="pattern-badge">
              ${p.pattern}
              <span class="pattern-tooltip">${p.description[lang] || p.description.en}</span>
            </div>
          `).join('')}
        </div>
        ` : ''}
      `;
      
      document.getElementById('trendsContent').innerHTML = trendsHTML;
    }

    // دالة متقدمة لاكتشاف الأنماط
    function detectAdvancedPatterns(recentHistory) {
      if (recentHistory.length < 5) return [];
      
      const patterns = [];
      const lastFive = recentHistory.slice(-5).join('');
      const lastTen = recentHistory.slice(-10).join('');
      
      // تعريف الأنماط الشائعة
      const commonPatterns = [
        {
          pattern: 'P-B-P-B-P',
          match: 'PBPBP',
          description: {
            ar: 'نمط تناوب بين اللاعب والمصرفي',
            en: 'Alternating Player-Banker pattern'
          },
          strength: 0.8
        },
        {
          pattern: '5P',
          match: 'PPPPP',
          description: {
            ar: '5 نتائج متتالية للاعب',
            en: '5 consecutive Player results'
          },
          strength: 0.9
        },
        {
          pattern: '3T+',
          match: /TTT/g,
          description: {
            ar: '3 تعادلات متتالية أو أكثر',
            en: '3 or more consecutive Ties'
          },
          strength: 0.7
        },
        {
          pattern: 'P-P-B-B-P',
          match: 'PPBBP',
          description: {
            ar: 'نمط مزدوج (لاعب-لاعب ثم مصرفي-مصرفي)',
            en: 'Double pattern (P-P then B-B)'
          },
          strength: 0.75
        }
      ];
      
      // التحقق من الأنماط
      commonPatterns.forEach(p => {
        if (typeof p.match === 'string' && lastFive === p.match) {
          patterns.push(p);
        } else if (p.match instanceof RegExp && p.match.test(lastTen)) {
          patterns.push(p);
        }
      });
      
      // اكتشاف سلاسل قصيرة
      const lastThree = recentHistory.slice(-3).join('');
      if (lastThree === 'PPP') {
        patterns.push({
          pattern: '3P',
          description: {
            ar: '3 لاعب متتالية',
            en: '3 consecutive Player'
          },
          strength: 0.6
        });
      }
      if (lastThree === 'BBB') {
        patterns.push({
          pattern: '3B',
          description: {
            ar: '3 مصرفي متتالية',
            en: '3 consecutive Banker'
          },
          strength: 0.6
        });
      }
      
      return patterns.sort((a, b) => b.strength - a.strength);
    }

    // ... (بقية الدوال كما هي) ...
  </script>
</body>
</html>
