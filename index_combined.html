
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Baccarat Predictor — Calibrated + Bankroll</title>
  <style>
    :root{
      --bg:#0b0f12; --panel:#12171c; --muted:#1b2229;
      --text:#e6edf3; --sub:#9aa7b2; --primary:#00a3ff;
      --ok:#29cc7a; --err:#ff5c5c; --amber:#ffb020;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);
      font-family:"Inter","Noto Kufi Arabic",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;line-height:1.45}
    .wrap{max-width:1200px;margin:28px auto;padding:0 14px}
    .panel{background:var(--panel);border:1px solid #233040;border-radius:16px;padding:14px;margin:10px 0}
    header{background:linear-gradient(180deg,#0e141a,transparent);border:1px solid #233040;border-radius:18px;padding:18px 20px;margin-bottom:10px}
    h1{margin:0 0 8px;font-size:22px;display:flex;align-items:center;gap:10px}
    .badge{font-size:12px;padding:3px 8px;border-radius:999px;background:#143954;color:#79c8ff;border:1px solid #204b69}
    .sub{color:var(--sub);font-size:13px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .btn{padding:10px 14px;border-radius:10px;border:1px solid #2b3a46;background:#162029;color:#cfe8ff;cursor:pointer;font-weight:600;min-width:96px}
    .btn:hover{filter:brightness(1.12)} .btn:active{transform:translateY(1px)}
    .b-bank{background:rgba(231,76,60,.16);border-color:rgba(231,76,60,.35);color:#ffb2aa}
    .b-play{background:rgba(46,134,222,.16);border-color:rgba(46,134,222,.35);color:#b9d8ff}
    .b-tie{background:rgba(46,204,113,.16);border-color:rgba(46,204,113,.35);color:#b5f2c9}
    .b-ghost{background:#121922;color:#b5c1cb}
    .box{background:var(--muted);border:1px solid #2a3a47;border-radius:12px;padding:10px;flex:1;min-width:130px}
    .box h3{margin:0 0 6px;font-size:13px;color:#a9b3bd}
    .stat{font-weight:800;font-size:20px}
    .grid-title{display:flex;align-items:center;gap:8px;font-size:14px;margin:0 0 6px}
    .pred{display:flex;align-items:center;gap:10px;font-size:18px;font-weight:800}
    .tag{font-size:12px;padding:4px 10px;border-radius:999px;background:#0f151b;border:1px solid #263340;color:#b2bec8}
    .tag.ok{background:rgba(41,204,122,.08);border-color:rgba(41,204,122,.35);color:#8ef0ba}
    .tag.warn{background:rgba(255,176,32,.08);border-color:rgba(255,176,32,.35);color:#ffd599}
    .tag.fail{background:rgba(255,92,92,.08);border-color:rgba(255,92,92,.35);color:#ffc6c6}
    .results{display:flex;gap:6px;flex-wrap:wrap}
    .res-box{width:14px;height:14px;border-radius:3px;border:1px solid #2b3a46;background:#0f161d}
    .res-box.ok{background:var(--ok);border-color:#35e39a}
    .res-box.fail{background:var(--err);border-color:#ff8f8f}
    .kv{display:grid;grid-template-columns:1fr auto;gap:6px;font-size:12px;color:#b4c0cb}
    .ctrls{display:grid;grid-template-columns:repeat(2,minmax(260px,1fr));gap:8px}
    .ctrl{background:#0f161d;border:1px solid #24323f;border-radius:10px;padding:8px 10px}
    .ctrl label{display:flex;justify-content:space-between;font-size:12px;color:#b5c1cb}
    input[type=range]{width:100%}
    input[type=number]{background:#0f161d;border:1px solid #24323f;color:#e6edf3;padding:6px;border-radius:8px;width:100px}
    select{background:#0f161d;border:1px solid #24323f;color:#e6edf3;padding:6px;border-radius:8px}
    .line{height:1px;background:#233040;margin:10px 0}
    .foot{color:#8092a0;font-size:12px;margin-top:8px}
  </style>
</head>
<body>
<div class="wrap">
  <header class="panel">
    <h1>Baccarat Predictor <span class="badge">Calibrated + Bankroll</span></h1>
    <div class="sub">تحليل أنماط + معايرة الثقة + إدارة رأس المال في صفحة واحدة.</div>
  </header>

  <section class="panel">
    <div class="row">
      <button class="btn b-play" id="btn-player">PLAYER (P)</button>
      <button class="btn b-bank" id="btn-banker">BANKER (B)</button>
      <button class="btn b-tie" id="btn-tie">TIE (T)</button>
      <button class="btn b-ghost" id="btn-back">⌫ Backspace</button>
      <button class="btn b-ghost" id="btn-reset">Reset</button>
      <button class="btn" id="btn-backtest">Backtest</button>
      <button class="btn" id="btn-export">Export JSON</button>
      <button class="btn" id="btn-import">Import JSON</button>
      <input type="file" id="file-import" accept="application/json" style="display:none">
    </div>

    <div class="row" style="margin-top:10px">
      <div class="box"><h3>Wins</h3><div class="stat" id="wins">0</div></div>
      <div class="box"><h3>Losses</h3><div class="stat" id="losses">0</div></div>
      <div class="box"><h3>Streak</h3><div class="stat" id="streak">0</div></div>
      <div class="box"><h3>Win rate</h3><div class="stat"><span id="winrate">0%</span></div></div>
      <div class="box">
        <h3>Backtest (Session)</h3>
        <div class="kv">
          <div>Accuracy</div><div id="bt-acc">—</div>
          <div>Rounds</div><div id="bt-n">—</div>
        </div>
      </div>
    </div>
  </section>

  <section class="panel">
    <div class="grid-title"><strong>التنبؤ</strong></div>
    <div class="pred">
      <span id="pred-main">—</span>
      <span class="tag" id="pred-conf">0%</span>
      <span class="tag warn" id="pred-adv">—</span>
    </div>
    <div class="kv" style="margin-top:6px">
      <div>Min History (غير التعادلات)</div><div><span id="minh-label">8</span></div>
      <div>Confidence Threshold</div><div><span id="thresh2-label">0.56</span></div>
    </div>
    <div class="line"></div>
    <div class="ctrls">
      <div class="ctrl"><label>Min History <span id="minh-val">8</span></label><input type="range" id="minh" min="0" max="30" step="1" value="8"></div>
      <div class="ctrl"><label>Majority Window (N) <span id="majN-val">12</span></label><input type="range" id="majN" min="4" max="30" step="1" value="12"></div>
      <div class="ctrl"><label>Weight — Streak <span id="w-streak-val">2.0</span></label><input type="range" id="w-streak" min="0" max="4" step="0.1" value="2.0"></div>
      <div class="ctrl"><label>Weight — PingPong <span id="w-pp-val">2.0</span></label><input type="range" id="w-pp" min="0" max="4" step="0.1" value="2.0"></div>
      <div class="ctrl"><label>Weight — Double <span id="w-double-val">1.5</span></label><input type="range" id="w-double" min="0" max="4" step="0.1" value="1.5"></div>
      <div class="ctrl"><label>Weight — BigEye <span id="w-eye-val">1.5</span></label><input type="range" id="w-eye" min="0" max="4" step="0.1" value="1.5"></div>
      <div class="ctrl"><label>Weight — SmallRoad <span id="w-small-val">1.0</span></label><input type="range" id="w-small" min="0" max="4" step="0.1" value="1.0"></div>
      <div class="ctrl"><label>Weight — Majority <span id="w-maj-val">1.0</span></label><input type="range" id="w-maj" min="0" max="4" step="0.1" value="1.0"></div>
      <div class="ctrl"><label>Bias — Banker <span id="w-bias-val">0.10</span></label><input type="range" id="w-bias" min="0" max="1" step="0.05" value="0.10"></div>
      <div class="ctrl"><label>Confidence Threshold <span id="thresh2-val">0.56</span></label><input type="range" id="thresh2" min="0.5" max="0.65" step="0.01" value="0.56"></div>
    </div>
  </section>

  <section class="panel">
    <div class="grid-title"><strong>💰 إدارة رأس المال</strong></div>
    <div class="row" style="gap:16px">
      <div class="box" style="min-width:240px">
        <div class="kv">
          <div>Bankroll</div><div><input id="bankroll" type="number" value="1600"></div>
          <div>Stake أولي</div><div><input id="stake0" type="number" value="20"></div>
          <div>Max Steps</div><div><input id="maxsteps" type="number" value="6"></div>
          <div>Stop-Loss</div><div><input id="stoploss" type="number" value="800"></div>
          <div>Target Profit</div><div><input id="target" type="number" value="600"></div>
          <div>Strategy</div>
          <div>
            <select id="strategy">
              <option value="martingale" selected>Martingale</option>
              <option value="flat">Flat</option>
              <option value="paroli">Paroli (على الربح)</option>
            </select>
          </div>
        </div>
      </div>
      <div class="box" style="min-width:260px">
        <div class="kv">
          <div>Current Step</div><div id="step">0</div>
          <div>Recommended Next Bet</div><div id="nextbet">—</div>
          <div>Total Exposure (est.)</div><div id="exposure">0</div>
          <div>Session Profit (units)</div><div id="profit">0</div>
          <div>Advisory</div><div><span class="tag" id="status">—</span></div>
        </div>
      </div>
    </div>
    <div class="foot">ملاحظة: الربح محسوب بوحدات (stake0 لكل دورة) لتبسيط التتبّع. اضبط القيم حسب أسلوبك.</div>
  </section>

  <section class="panel">
    <div class="grid-title"><strong>نتائج التنبؤ (آخر 60)</strong></div>
    <div class="results" id="pred-results"></div>
  </section>

  <section class="panel foot">
    ♠️ مشروع تعليمي. لا يضمن الربح ولا يُعتبر نصيحة قمار. الجلسة تُحفظ محلياً (localStorage) ويمكن تصدير/استيراد JSON.
  </section>
</div>

<script>
// ====== State & Storage ======
const state = {
  history: JSON.parse(localStorage.getItem("cb_history")||"[]"),
  lastPrediction: null,
  results: JSON.parse(localStorage.getItem("cb_results")||"[]"),
  stats: JSON.parse(localStorage.getItem("cb_stats")||'{"wins":0,"losses":0,"streak":0}')
};
function save(){
  localStorage.setItem("cb_history", JSON.stringify(state.history));
  localStorage.setItem("cb_results", JSON.stringify(state.results));
  localStorage.setItem("cb_stats", JSON.stringify(state.stats));
}

// ====== Helpers ======
const $ = (s)=>document.querySelector(s);
const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
function nonTies(h){ return h.filter(x=>x!=='T'); }

// ====== Roads (lightweight used for signals) ======
function buildBigRoad(history){
  const cols=[]; let lastNonTie=null; let lastCol=-1;
  for(const r of history){
    if(r==='T'){ if(lastCol>=0){ const col=cols[lastCol]; col[col.length-1].ties=(col[col.length-1].ties||0)+1;} continue; }
    if(lastNonTie===null){ cols.push([{c:r, ties:0}]); lastNonTie=r; lastCol=0; continue; }
    const same = (r===lastNonTie);
    const curr = cols[lastCol];
    const left = (lastCol>0)?cols[lastCol-1]:null;
    if(same){
      const canGoDown = curr.length<6 && (!left || left.length<curr.length+1);
      if(canGoDown){ curr.push({c:r,ties:0}); }
      else{ cols.push([{c:r,ties:0}]); lastCol++; }
    }else{
      cols.push([{c:r,ties:0}]); lastCol++; lastNonTie=r;
    }
  }
  return cols;
}
function buildDerivedFromBigRoad(cols, offset){
  const signs=[];
  function colH(i){ return (i>=0 && i<cols.length)?cols[i].length:0; }
  for(let j=1;j<cols.length;j++){
    const curr = cols[j];
    for(let r=0;r<curr.length;r++){
      const left=j-1, ref=j-1-offset;
      let color;
      if(r===0){ color = (colH(left)===colH(ref)) ? 'R':'B'; }
      else {
        const leftOk = colH(left)>=(r+1);
        const refOk  = colH(ref)>=(r+1);
        color = (leftOk===refOk)?'R':'B';
      }
      signs.push(color);
    }
  }
  return signs;
}

// ====== Config getters & labels ======
const cfg = {
  get minh(){ return +$("#minh").value; },
  get majN(){ return +$("#majN").value; },
  get wStreak(){ return +$("#w-streak").value; },
  get wPP(){ return +$("#w-pp").value; },
  get wDouble(){ return +$("#w-double").value; },
  get wEye(){ return +$("#w-eye").value; },
  get wSmall(){ return +$("#w-small").value; },
  get wMaj(){ return +$("#w-maj").value; },
  get wBias(){ return +$("#w-bias").value; },
  get confThresh(){ return +$("#thresh2").value; }
};
function syncLabels(){
  $("#minh-label").textContent = cfg.minh;
  $("#thresh2-label").textContent = cfg.confThresh.toFixed(2);
  $("#minh-val").textContent = cfg.minh;
  $("#majN-val").textContent = cfg.majN;
  $("#w-streak-val").textContent = cfg.wStreak.toFixed(1);
  $("#w-pp-val").textContent = cfg.wPP.toFixed(1);
  $("#w-double-val").textContent = cfg.wDouble.toFixed(1);
  $("#w-eye-val").textContent = cfg.wEye.toFixed(1);
  $("#w-small-val").textContent = cfg.wSmall.toFixed(1);
  $("#w-maj-val").textContent = cfg.wMaj.toFixed(1);
  $("#w-bias-val").textContent = cfg.wBias.toFixed(2);
  $("#thresh2-val").textContent = cfg.confThresh.toFixed(2);
}

// ====== Predictor ======
function analyze(history){
  const votes = {B:0, P:0, T:0}; const notes=[];
  const h = nonTies(history);
  if(h.length===0) return {choice:null, conf:0, votes, notes, strength:0};

  const last = h[h.length-1];

  if(h.length < cfg.minh){
    notes.push(`History too short: ${h.length}/${cfg.minh}`);
    return {choice:null, conf:0, votes, notes, strength:0};
  }

  // Streak
  let streak=1;
  for(let i=h.length-2;i>=0;i--){ if(h[i]===last) streak++; else break; }
  if(streak>=2){ votes[last]+=cfg.wStreak; notes.push(`Streak x${streak} → stay ${last}`); }

  // Ping-Pong
  if(h.length>=4){
    const a=h.slice(-4).join('');
    if(a==='BPBP' || a==='PBPB'){ const next=(last==='B'?'P':'B'); votes[next]+=cfg.wPP; notes.push(`Ping-Pong → ${next}`); }
  }

  // Double Pattern
  if(h.length>=6){
    const s=h.slice(-6); const pairs=[s[0]===s[1], s[2]===s[3], s[4]===s[5]];
    if(pairs.every(x=>x) && (s[1]!==s[3])){
      const next=(last==='B'?'P':'B');
      votes[next]+=cfg.wDouble; notes.push(`Double Pattern → ${next}`);
    }
  }

  // Roads
  const cols=buildBigRoad(history);
  const eye=buildDerivedFromBigRoad(cols,1);
  const small=buildDerivedFromBigRoad(cols,2);
  if(eye.length){ const e=eye[eye.length-1]; const v=(e==='R')? last : (last==='B'?'P':'B'); votes[v]+=cfg.wEye; notes.push(`BigEye ${e}`); }
  if(small.length){ const s=small[small.length-1]; const v=(s==='R')? last : (last==='B'?'P':'B'); votes[v]+=cfg.wSmall; notes.push(`SmallRoad ${s}`); }

  // Majority last N
  const N = Math.min(cfg.majN, h.length);
  const recent=h.slice(-N);
  const b=recent.filter(x=>x==='B').length, p=recent.length-b;
  if(b!==p){ const maj=b>p?'B':'P'; votes[maj]+=cfg.wMaj; notes.push(`Majority last ${N}: ${maj}`); }

  // Banker bias
  votes['B'] += cfg.wBias;

  const sum=votes.B+votes.P+votes.T;
  if(sum<=0) return {choice:null, conf:0, votes, notes, strength:0};
  const pb=votes.B/sum, pp=votes.P/sum;
  const choice = (pb>pp)?'B':'P';
  const top = Math.max(pb,pp), second = Math.min(pb,pp);
  const strength = (top-second);
  const baseConf = top;
  const lenBoost = Math.min(0.08, (h.length/100)*0.08);
  const conf = clamp(baseConf + (strength*0.5) + lenBoost, 0.5, 0.99);

  return {choice, conf, votes, notes, strength};
}

// ====== Rendering & Scoring ======
function render(){
  $("#wins").textContent = state.stats.wins;
  $("#losses").textContent = state.stats.losses;
  $("#streak").textContent = state.stats.streak;
  const tot = state.stats.wins + state.stats.losses;
  $("#winrate").textContent = (tot? Math.round((state.stats.wins/tot)*100):0) + "%";

  const p = state.lastPrediction;
  const adv = $("#pred-adv");
  if(!p || !p.choice){
    $("#pred-main").textContent = "—";
    $("#pred-conf").textContent = "0%";
    adv.textContent = "أدخل تاريخ أكثر أو العتبة عالية";
  }else{
    $("#pred-main").textContent = (p.choice==='B'?'BANKER':'PLAYER');
    $("#pred-conf").textContent = Math.round(p.conf*100) + "%";
    adv.textContent = (p.conf >= cfg.confThresh) ? "مسموح بالمخاطرة (ضمن قواعدك)" : "🚫 تخطّى هذه الجولة (ثقة ضعيفة)";
  }

  const cont = $("#pred-results"); cont.innerHTML="";
  for(const r of state.results.slice(-60)){
    const d = document.createElement("div");
    d.className = "res-box " + (r.ok?"ok":"fail");
    cont.appendChild(d);
  }

  updateBankrollPanel();
}
function recalc(){
  state.lastPrediction = analyze(state.history);
  render(); save();
}
function recordResult(sym){
  if(state.lastPrediction && state.lastPrediction.choice && sym!=='T'){
    const ok = (state.lastPrediction.choice === sym) && (state.lastPrediction.conf >= cfg.confThresh);
    // نحتسب الربح/الخسارة غير إذا كنا فعلاً سنلعب (ثقة ≥ عتبة)
    if(state.lastPrediction.conf >= cfg.confThresh){
      if(ok){ state.stats.wins++; state.stats.streak++; }
      else{ state.stats.losses++; state.stats.streak=0; }
      state.results.push({pred:state.lastPrediction.choice, actual:sym, ok});
    } else {
      // نُسجل النتيجة كتاريخ فقط بلا ما تدخل للإحصائيات
      state.results.push({pred:state.lastPrediction.choice, actual:sym, ok:null});
    }
  }
  state.history.push(sym);
  recalc();
}
function backspace(){
  if(!state.history.length) return;
  const last = state.history.pop();
  if(state.results.length){
    const r = state.results.pop();
    if(r.ok===true) state.stats.wins--;
    if(r.ok===false) state.stats.losses--;
    // recompute streak
    let s=0; for(let i=state.results.length-1;i>=0;i--){ if(state.results[i].ok===true) s++; else break; } state.stats.streak=s;
  }
  recalc();
}
function resetAll(){
  state.history=[]; state.lastPrediction=null; state.results=[];
  state.stats={wins:0, losses:0, streak:0}; recalc();
}

// ====== Backtest ======
function backtest(){
  const h = state.history.slice();
  let wins=0, losses=0, n=0;
  for(let i=0;i<h.length-1;i++){
    const hist = h.slice(0,i+1);
    const nxt = h[i+1];
    if(nxt==='T') continue;
    const p = analyze(hist);
    if(!p.choice) continue;
    if(p.conf < cfg.confThresh) continue; // only when we'd actually bet
    n++;
    if(p.choice===nxt) wins++; else losses++;
  }
  $("#bt-acc").textContent = n? (Math.round((wins/n)*100)+"%") : "—";
  $("#bt-n").textContent = n || "—";
}

// ====== Bankroll Panel ======
function consecutiveLossesInRow(){
  let c=0;
  for(let i=state.results.length-1;i>=0;i--){
    const r=state.results[i];
    if(r.ok===false) c++;
    else if(r.ok===true) break;
  }
  return c;
}
function updateBankrollPanel(){
  const stake0=+$("#stake0").value, maxsteps=+$("#maxsteps").value;
  const stoploss=+$("#stoploss").value, target=+$("#target").value;
  const bankroll=+$("#bankroll").value;
  const strat=$("#strategy").value;
  const confOK = (state.lastPrediction && state.lastPrediction.conf >= cfg.confThresh);

  let step=0, nextbet=0, exposure=0;
  let profitUnits = (state.stats.wins - state.stats.losses); // unit per bet allowed (only counted when conf OK)

  if(strat==="martingale"){
    const L = consecutiveLossesInRow();
    step = Math.min(L+1, maxsteps);
    nextbet = confOK ? (stake0 * Math.pow(2, step-1)) : 0;
    exposure = stake0*(Math.pow(2, step)-1);
  } else if(strat==="flat"){
    step = 1;
    nextbet = confOK ? stake0 : 0;
    exposure = nextbet;
  } else if(strat==="paroli"){
    // simple paroli: double on wins, reset on loss, cap at 3 steps
    let W=0;
    for(let i=state.results.length-1;i>=0;i--){
      const r=state.results[i];
      if(r.ok===true) W++; else if(r.ok===false) break;
    }
    step = Math.min(W+1, 3);
    nextbet = confOK ? (stake0 * Math.pow(2, step-1)) : 0;
    exposure = nextbet;
  }

  $("#step").textContent = step;
  $("#nextbet").textContent = nextbet ? nextbet : "—";
  $("#exposure").textContent = exposure;
  $("#profit").textContent = profitUnits;

  let st = confOK ? "Ready" : "🚫 لا تراهن: ثقة ضعيفة";
  if(exposure>=stoploss) st="⚠️ Stop-Loss Reached";
  if(profitUnits*stake0 >= target) st="✅ Target Profit";
  if(exposure>=bankroll) st="❌ Bankroll Exhausted";
  $("#status").textContent = st;
}

// ====== Bindings ======
$("#btn-player").onclick = ()=>recordResult('P');
$("#btn-banker").onclick = ()=>recordResult('B');
$("#btn-tie").onclick    = ()=>recordResult('T');
$("#btn-back").onclick   = backspace;
$("#btn-reset").onclick  = resetAll;
$("#btn-backtest").onclick = backtest;
$("#btn-export").onclick = ()=>{
  const data = { history: state.history, results: state.results, stats: state.stats };
  const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a"); a.href=url; a.download="baccarat-session.json"; a.click();
  setTimeout(()=>URL.revokeObjectURL(url), 1000);
};
$("#btn-import").onclick = ()=>$("#file-import").click();
$("#file-import").addEventListener("change",(e)=>{
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=()=>{
    try{
      const data=JSON.parse(r.result);
      state.history = Array.isArray(data.history)? data.history : [];
      state.results = Array.isArray(data.results)? data.results : [];
      state.stats   = data.stats || {wins:0,losses:0,streak:0};
      recalc(); alert("تم الاستيراد.");
    }catch(err){ alert("ملف غير صالح."); }
  };
  r.readAsText(f); e.target.value="";
});

document.querySelectorAll("input[type=range], input[type=number], select").forEach(el=>{
  el.addEventListener("input", ()=>{ syncLabels(); render(); save(); });
});

// init
syncLabels(); recalc();
</script>
</body>
</html>
